version: "3.8"

networks:
  backend:
    external: true

services:
  elasticsearch:
    build:
      context: ./elasticsearch
      args:
        - ELK_VERSION=${ELK_VERSION}
    container_name: ${ELASTICSEARCH_HOSTNAME}
    hostname: ${ELASTICSEARCH_HOSTNAME}
    volumes:
      - ${ELASTICSEARCH_DATA_PATH}:/usr/share/elasticsearch/data
      - ${ELASTICSEARCH_LOG_PATH}:/usr/share/elasticsearch/logs
      - ${ELASTICSEARCH_PLUGIN_PATH}:/usr/share/elasticsearch/plugins
      - ${ELASTICSEARCH_CONFIG_PATH}/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml
    environment:
      TZ: ${TZ}
      ES_JAVA_OPTS: ${ES_JAVA_OPTS}
      ELASTIC_USERNAME: ${ELASTIC_USERNAME}
      ELASTIC_PASSWORD: ${ELASTIC_PASSWORD}
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    ports:
      - "${ELASTICSEARCH_HOST_HTTP_PORT}:9200"
      - "${ELASTICSEARCH_HOST_TRANSPORT_PORT}:9300"
    networks:
      backend:
        ipv4_address: ${ELASTICSEARCH_IP}
#    healthcheck:
#      test:
#        [
#          "CMD-SHELL",
#          "curl -s --user ${ELASTIC_USERNAME}:${ELASTIC_PASSWORD} http://localhost:9200 | grep -q 'missing authentication credentials'",
#        ]
#      interval: 10s
#      timeout: 10s
#      retries: 120

  kibana:
    build:
      context: ./kibana
      args:
        - ELK_VERSION=${ELK_VERSION}
    container_name: ${KIBANA_HOSTNAME}
    hostname: ${KIBANA_HOSTNAME}
    ports:
      - "${KIBANA_HTTP_PORT}:5601"
    volumes:
      - ${KIBANA_DATA_PATH}:/usr/share/kibana/data
      - ${KIBANA_CONFIG_PATH}/kibana.yml:/usr/share/kibana/config/kibana.yml
    environment:
      TZ: ${TZ}
      ELASTICSEARCH_HOSTS: '["http://${ELASTICSEARCH_HOSTNAME}:9200"]'
      #ELASTICSEARCH_USERNAME: ${KIBANA_USERNAME}
      #ELASTIC_PASSWORD: ${KIBANA_PASSWORD}
    depends_on:
      - ${ELASTICSEARCH_HOSTNAME}
    networks:
      backend:
        ipv4_address: ${KIBANA_IP}